# docker-compose.yml
#
# CYROID Docker Compose Configuration (Production)
#
# For development with local builds and hot-reload, use with docker-compose.override.yml:
#   docker-compose up
#
# For production with pre-built GHCR images:
#   docker-compose -f docker-compose.yml up
#
# Networks:
#   - cyroid-mgmt (172.30.0.0/24): CYROID infrastructure services
#   - cyroid-ranges (172.30.1.0/24): Range DinD containers
#
services:
  db:
    image: ghcr.io/jongodb/cyroid-db:latest
    environment:
      POSTGRES_USER: cyroid
      POSTGRES_PASSWORD: cyroid
      POSTGRES_DB: cyroid
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.11
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cyroid"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: ghcr.io/jongodb/cyroid-redis:latest
    ports:
      - "6379:6379"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.12
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio:
    image: ghcr.io/jongodb/cyroid-storage:latest
    environment:
      MINIO_ROOT_USER: cyroid
      MINIO_ROOT_PASSWORD: cyroid123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.13
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/jongodb/cyroid-api:latest
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5)\" || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      DATABASE_URL: postgresql://cyroid:cyroid@172.30.0.11:5432/cyroid
      REDIS_URL: redis://172.30.0.12:6379/0
      MINIO_ENDPOINT: 172.30.0.13:9000
      MINIO_ACCESS_KEY: cyroid
      MINIO_SECRET_KEY: cyroid123
      ISO_CACHE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      TEMPLATE_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      VM_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      GLOBAL_SHARED_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/shared
      # DinD Configuration (all ranges run in isolated DinD containers)
      DIND_IMAGE: ${DIND_IMAGE:-ghcr.io/jongodb/cyroid-dind:latest}
      DIND_STARTUP_TIMEOUT: ${DIND_STARTUP_TIMEOUT:-60}
      DIND_DOCKER_PORT: ${DIND_DOCKER_PORT:-2375}
      CYROID_MGMT_NETWORK: cyroid-mgmt
      CYROID_MGMT_SUBNET: 172.30.0.0/24
      CYROID_RANGES_NETWORK: cyroid-ranges
      CYROID_RANGES_SUBNET: 172.30.1.0/24
      # Traefik dynamic config directory (shared with Traefik for DinD VNC routing)
      TRAEFIK_VNC_ROUTES_DIR: /app/traefik/dynamic
    volumes:
      # Mount Docker socket to manage DinD containers on host
      - /var/run/docker.sock:/var/run/docker.sock
      # Use bind mounts so spawned VM containers can access these paths
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
      - ${CYROID_DATA_DIR:-/data/cyroid}/catalogs:${CYROID_DATA_DIR:-/data/cyroid}/catalogs
      # Runtime directories for catalog-installed content
      - ${CYROID_DATA_DIR:-/data/cyroid}/scenarios:/data/scenarios
      - ${CYROID_DATA_DIR:-/data/cyroid}/images:/data/images
      # Shared directory for Traefik dynamic config (VNC routes)
      - ./traefik/dynamic:/app/traefik/dynamic
    expose:
      - "8000"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.10
      cyroid-ranges:  # Needs access to range DinD containers
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: bash -c "alembic upgrade head && uvicorn cyroid.main:app --host 0.0.0.0 --port 8000"
    labels:
      - "traefik.enable=true"
      # API service
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      # HTTP router for /api
      - "traefik.http.routers.api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.service=api"
      # HTTPS router for /api
      - "traefik.http.routers.api-secure.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api-secure.entrypoints=websecure"
      - "traefik.http.routers.api-secure.tls=true"
      - "traefik.http.routers.api-secure.service=api"
      # HTTP router for /ws (WebSocket endpoints for console, VNC proxy, etc.)
      - "traefik.http.routers.ws.rule=PathPrefix(`/ws`)"
      - "traefik.http.routers.ws.entrypoints=web"
      - "traefik.http.routers.ws.service=api"
      # HTTPS router for /ws
      - "traefik.http.routers.ws-secure.rule=PathPrefix(`/ws`)"
      - "traefik.http.routers.ws-secure.entrypoints=websecure"
      - "traefik.http.routers.ws-secure.tls=true"
      - "traefik.http.routers.ws-secure.service=api"

  worker:
    image: ghcr.io/jongodb/cyroid-worker:latest
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import os; exit(0 if any('dramatiq' in open(f'/proc/{p}/cmdline').read() for p in os.listdir('/proc') if p.isdigit() and os.path.exists(f'/proc/{p}/cmdline')) else 1)\""]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      DATABASE_URL: postgresql://cyroid:cyroid@172.30.0.11:5432/cyroid
      REDIS_URL: redis://172.30.0.12:6379/0
      MINIO_ENDPOINT: 172.30.0.13:9000
      MINIO_ACCESS_KEY: cyroid
      MINIO_SECRET_KEY: cyroid123
      ISO_CACHE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      TEMPLATE_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      VM_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      GLOBAL_SHARED_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/shared
      # DinD Configuration (all ranges run in isolated DinD containers)
      DIND_IMAGE: ${DIND_IMAGE:-ghcr.io/jongodb/cyroid-dind:latest}
      DIND_STARTUP_TIMEOUT: ${DIND_STARTUP_TIMEOUT:-60}
      DIND_DOCKER_PORT: ${DIND_DOCKER_PORT:-2375}
      CYROID_MGMT_NETWORK: cyroid-mgmt
      CYROID_MGMT_SUBNET: 172.30.0.0/24
      CYROID_RANGES_NETWORK: cyroid-ranges
      CYROID_RANGES_SUBNET: 172.30.1.0/24
      # Traefik dynamic config directory (shared with Traefik for DinD VNC routing)
      TRAEFIK_VNC_ROUTES_DIR: /app/traefik/dynamic
    volumes:
      # Mount Docker socket to manage DinD containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Use bind mounts so spawned VM containers can access these paths
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
      - ${CYROID_DATA_DIR:-/data/cyroid}/catalogs:${CYROID_DATA_DIR:-/data/cyroid}/catalogs
      # Runtime directories for catalog-installed content
      - ${CYROID_DATA_DIR:-/data/cyroid}/scenarios:/data/scenarios
      - ${CYROID_DATA_DIR:-/data/cyroid}/images:/data/images
      # Shared directory for Traefik dynamic config (VNC routes)
      - ./traefik/dynamic:/app/traefik/dynamic
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.15
      cyroid-ranges:  # Needs access to range DinD containers
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: dramatiq cyroid.tasks --processes 2 --threads 4

  registry:
    image: registry:2
    restart: unless-stopped
    ports:
      - "127.0.0.1:5000:5000"  # Expose on localhost for host Docker to push images
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - ${CYROID_DATA_DIR:-/data/cyroid}/registry:/var/lib/registry
      - ./config/registry-config.yml:/etc/docker/registry/config.yml:ro
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.16
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/v2/"]
      interval: 10s
      timeout: 5s
      retries: 3

  frontend:
    image: ghcr.io/jongodb/cyroid-frontend:latest
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
    expose:
      - "80"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.20
    labels:
      - "traefik.enable=true"
      # Frontend service (production uses nginx on port 80)
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      # HTTP router (lowest priority, catch-all)
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.routers.frontend.service=frontend"
      # HTTPS router (lowest priority, catch-all)
      - "traefik.http.routers.frontend-secure.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.frontend-secure.tls=true"
      - "traefik.http.routers.frontend-secure.priority=1"
      - "traefik.http.routers.frontend-secure.service=frontend"

  traefik:
    image: ghcr.io/jongodb/cyroid-proxy:latest
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8082/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    # Use static config file instead of command line args
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      # Dynamic config directory (base.yml + VNC routes written by API)
      - ./traefik/dynamic:/etc/traefik/dynamic
      - ./certs:/etc/traefik/certs:ro
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.14
      cyroid-ranges:  # Needs to route to range DinD containers for VNC

# Network definitions (external - created by scripts/init-networks.sh)
networks:
  # Network for CYROID infrastructure services
  cyroid-mgmt:
    external: true

  # Network for range DinD containers
  cyroid-ranges:
    external: true

volumes:
  postgres_data:
  minio_data:
  frontend_node_modules:
