# docker-compose.yml
#
# CYROID Docker Compose Configuration
#
# Networks:
#   - cyroid-mgmt (172.30.0.0/24): CYROID infrastructure services
#   - cyroid-ranges (172.30.1.0/24): Range DinD containers
#   - traefik-routing: Traefik to service routing
#
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: cyroid
      POSTGRES_PASSWORD: cyroid
      POSTGRES_DB: cyroid
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.11
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cyroid"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.12
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: cyroid
      MINIO_ROOT_PASSWORD: cyroid123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.13
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://cyroid:cyroid@172.30.0.11:5432/cyroid
      REDIS_URL: redis://172.30.0.12:6379/0
      MINIO_ENDPOINT: 172.30.0.13:9000
      MINIO_ACCESS_KEY: cyroid
      MINIO_SECRET_KEY: cyroid123
      ISO_CACHE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      TEMPLATE_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      VM_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      GLOBAL_SHARED_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/shared
      # DinD Configuration (all ranges run in isolated DinD containers)
      DIND_IMAGE: ${DIND_IMAGE:-docker:24-dind}
      DIND_STARTUP_TIMEOUT: ${DIND_STARTUP_TIMEOUT:-60}
      DIND_DOCKER_PORT: ${DIND_DOCKER_PORT:-2375}
      CYROID_MGMT_NETWORK: cyroid-mgmt
      CYROID_MGMT_SUBNET: 172.30.0.0/24
      CYROID_RANGES_NETWORK: cyroid-ranges
      CYROID_RANGES_SUBNET: 172.30.1.0/24
      # Traefik dynamic config directory (shared with Traefik for DinD VNC routing)
      TRAEFIK_VNC_ROUTES_DIR: /app/traefik/dynamic
    volumes:
      - ./backend:/app
      # Mount Docker socket to manage DinD containers on host
      - /var/run/docker.sock:/var/run/docker.sock
      # Use bind mounts so spawned VM containers can access these paths
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
      # Seed templates for built-in CYROID templates
      - ./data/seed-templates:/data/seed-templates:ro
      # Seed blueprints for built-in CYROID blueprints
      - ./data/seed-blueprints:/data/seed-blueprints:ro
      # Training scenarios (read from filesystem, writable for uploads)
      - ./data/scenarios:/data/scenarios
      # Buildable Docker images with Dockerfiles
      - ./data/images:/data/images
      # Shared directory for Traefik dynamic config (VNC routes)
      - ./traefik/dynamic:/app/traefik/dynamic
    expose:
      - "8000"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.10
      cyroid-ranges:  # Needs access to range DinD containers
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: bash -c "alembic upgrade head && uvicorn cyroid.main:app --host 0.0.0.0 --port 8000 --reload"
    labels:
      - "traefik.enable=true"
      # API service
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      # HTTP router for /api
      - "traefik.http.routers.api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.service=api"
      # HTTPS router for /api
      - "traefik.http.routers.api-secure.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api-secure.entrypoints=websecure"
      - "traefik.http.routers.api-secure.tls=true"
      - "traefik.http.routers.api-secure.service=api"
      # HTTP router for /ws (WebSocket endpoints for console, VNC proxy, etc.)
      - "traefik.http.routers.ws.rule=PathPrefix(`/ws`)"
      - "traefik.http.routers.ws.entrypoints=web"
      - "traefik.http.routers.ws.service=api"
      # HTTPS router for /ws
      - "traefik.http.routers.ws-secure.rule=PathPrefix(`/ws`)"
      - "traefik.http.routers.ws-secure.entrypoints=websecure"
      - "traefik.http.routers.ws-secure.tls=true"
      - "traefik.http.routers.ws-secure.service=api"

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://cyroid:cyroid@172.30.0.11:5432/cyroid
      REDIS_URL: redis://172.30.0.12:6379/0
      MINIO_ENDPOINT: 172.30.0.13:9000
      MINIO_ACCESS_KEY: cyroid
      MINIO_SECRET_KEY: cyroid123
      ISO_CACHE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      TEMPLATE_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      VM_STORAGE_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      GLOBAL_SHARED_DIR: ${CYROID_DATA_DIR:-/data/cyroid}/shared
      # DinD Configuration (all ranges run in isolated DinD containers)
      DIND_IMAGE: ${DIND_IMAGE:-docker:24-dind}
      DIND_STARTUP_TIMEOUT: ${DIND_STARTUP_TIMEOUT:-60}
      DIND_DOCKER_PORT: ${DIND_DOCKER_PORT:-2375}
      CYROID_MGMT_NETWORK: cyroid-mgmt
      CYROID_MGMT_SUBNET: 172.30.0.0/24
      CYROID_RANGES_NETWORK: cyroid-ranges
      CYROID_RANGES_SUBNET: 172.30.1.0/24
    volumes:
      - ./backend:/app
      # Mount Docker socket to manage DinD containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Use bind mounts so spawned VM containers can access these paths
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.15
      cyroid-ranges:  # Needs access to range DinD containers
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: dramatiq cyroid.tasks --processes 2 --threads 4

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    expose:
      - "5173"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.20
    environment:
      - CHOKIDAR_USEPOLLING=true
    labels:
      - "traefik.enable=true"
      # Frontend service
      - "traefik.http.services.frontend.loadbalancer.server.port=5173"
      # HTTP router (lowest priority, catch-all)
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.routers.frontend.service=frontend"
      # HTTPS router (lowest priority, catch-all)
      - "traefik.http.routers.frontend-secure.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.frontend-secure.tls=true"
      - "traefik.http.routers.frontend-secure.priority=1"
      - "traefik.http.routers.frontend-secure.service=frontend"

  traefik:
    image: traefik:v2.11
    # Use static config file instead of command line args
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      # Dynamic config directory (base.yml + VNC routes written by API)
      - ./traefik/dynamic:/etc/traefik/dynamic
      - ./certs:/etc/traefik/certs:ro
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    networks:
      cyroid-mgmt:
        ipv4_address: 172.30.0.14
      cyroid-ranges:  # Needs to route to range DinD containers for VNC
      traefik-routing:

# Network definitions (external - created by scripts/init-networks.sh)
networks:
  # Network for CYROID infrastructure services
  cyroid-mgmt:
    external: true

  # Network for range DinD containers
  cyroid-ranges:
    external: true

  # Traefik routing network
  traefik-routing:
    external: true

volumes:
  postgres_data:
  minio_data:
  frontend_node_modules:
