# CYROID Catalog — Design Document

**Date**: 2026-01-28
**Status**: Draft
**Scope**: Separate training content from CYROID core into a standalone catalog repository

---

## Problem

Training content (seed blueprints, scenarios, Dockerfile projects, VM template definitions) is bundled inside the CYROID codebase under `data/`. This causes:

- **Repo bloat** for users who don't need bundled content
- **No content distribution mechanism** — sharing new training ranges requires manual export/import
- **Tight coupling** between the platform and its content
- **No discoverability** — users can't browse available training content before installing

## Solution

Create a separate `cyroid-catalog` repository that acts as a content distribution hub. CYROID instances connect to one or more catalog sources (git repos or HTTP endpoints) and present a browsable "Content Catalog" UI for installing training content on demand.

---

## Catalog Repository Structure

```
cyroid-catalog/
├── catalog.yaml                  # Root manifest: name, version, maintainer
├── images/                       # Shared Dockerfile projects
│   ├── kali-attack/
│   │   ├── image.yaml            # name, tag, description, arch, build args
│   │   └── Dockerfile
│   ├── samba-dc/
│   ├── redteam-lab-wordpress/
│   ├── redteam-lab-fileserver/
│   ├── redteam-lab-workstation/
│   └── ...
├── base-images/                  # VM base image definitions (metadata only)
│   └── manifest.yaml
├── blueprints/                   # Self-contained range packages
│   ├── red-team-training-lab/
│   │   ├── blueprint.yaml        # Range config (networks, VMs, image refs)
│   │   ├── msel.md               # MSEL document
│   │   ├── content/              # Student guides, instructor notes
│   │   │   ├── student-guide.md
│   │   │   └── assets/
│   │   └── README.md             # Human-readable description
│   ├── incident-response-drill/
│   └── ...
├── scenarios/                    # Standalone scenario timelines
│   ├── ransomware-attack.yaml
│   ├── apt-intrusion.yaml
│   ├── insider-threat.yaml
│   └── ...
├── scripts/
│   └── generate-index.py         # Builds index.json from directory tree
└── index.json                    # Auto-generated catalog index
```

### Key Principles

- **Hybrid layout**: Shared resources (`images/`, `base-images/`) at the top level. Blueprint packages reference shared images by name rather than embedding Dockerfiles.
- **Self-contained blueprints**: Each blueprint directory includes its config, MSEL, content guides, and README. Everything except shared images.
- **`index.json`**: Auto-generated by a script (run via pre-commit hook or CI). Aggregates all item manifests into a single searchable index for fast consumption.

---

## Catalog Index Format

```json
{
  "catalog": {
    "name": "Official CYROID Catalog",
    "version": "1.0.0",
    "maintainer": "your-org",
    "generated_at": "2026-01-28T00:00:00Z"
  },
  "items": [
    {
      "id": "red-team-training-lab",
      "type": "blueprint",
      "name": "Red Team Training Lab",
      "description": "Multi-network red team exercise with attack/defense phases",
      "tags": ["red-team", "intermediate", "network-attack"],
      "version": "1.0.0",
      "path": "blueprints/red-team-training-lab",
      "requires_images": ["kali-attack", "samba-dc", "redteam-lab-wordpress"],
      "includes_msel": true,
      "includes_content": true,
      "checksum": "sha256:abc123..."
    }
  ]
}
```

Item types: `blueprint`, `scenario`, `image`, `base_image`, `content`.

For HTTP serving: host the repo as static files (GitHub Pages, Nginx, S3). CYROID fetches `index.json` then downloads individual items by `path`.

---

## CYROID Integration

### Catalog Source Model

New database table:

```
catalog_sources:
  id             UUID PK
  name           VARCHAR        -- "Official CYROID Catalog"
  source_type    ENUM           -- git | http | local
  url            VARCHAR        -- repo URL, HTTP base URL, or local path
  branch         VARCHAR        -- git branch (default: "main")
  enabled        BOOLEAN
  last_synced    TIMESTAMP
  sync_status    ENUM           -- idle | syncing | error
  error_message  TEXT           -- last error details
  created_by     FK(users)
  created_at     TIMESTAMP
  updated_at     TIMESTAMP
```

### Installed Item Tracking

```
catalog_installed_items:
  id               UUID PK
  catalog_source_id  FK(catalog_sources)
  catalog_item_id    VARCHAR       -- e.g. "red-team-training-lab"
  item_type          ENUM          -- blueprint | scenario | image | template | content
  installed_version  VARCHAR       -- version string or git commit hash
  local_resource_id  UUID          -- FK to blueprint/scenario/etc. in CYROID
  installed_at       TIMESTAMP
  installed_by       FK(users)
```

This enables "Installed" / "Update Available" status tracking in the UI.

### Sync Behavior

| Source Type | Sync Action |
|-------------|-------------|
| **git** | Clone (first sync) or pull into `/data/cyroid/catalogs/<source-id>/`. Read `index.json` from clone. |
| **http** | Fetch `<url>/index.json`. Individual items fetched on-demand during install. |
| **local** | Read `index.json` from the directory path. No network required. |

- Sync triggered manually via "Refresh Catalog" button in UI
- Fallback: if `index.json` is missing, walk the directory tree to build the index dynamically

### Install Flow

When a user clicks "Install" on a catalog item:

1. **Blueprint**: Read `blueprint.yaml`, import via existing blueprint import pipeline. Copy referenced Dockerfiles from `images/` to `/data/images/`. Import content items. Create `catalog_installed_items` record.
2. **Scenario**: Copy YAML to the scenarios directory.
3. **Image**: Copy Dockerfile project to `/data/images/`. Optionally trigger build.
4. **Template**: Add to seed templates manifest.
5. **Content**: Import via existing content import pipeline.

The existing blueprint import/export system is reused — the catalog install action essentially feeds content into the same pipeline that handles ZIP imports.

---

## Catalog Browser UI

New page: `/catalog` — accessible from the sidebar navigation.

### Layout

- **Header**: "Content Catalog" title, catalog source selector dropdown (if multiple sources), "Refresh" button
- **Filter bar**: Type tabs (All | Blueprints | Scenarios | Images | Content), search input, tag filter chips
- **Card grid**: Each catalog item as a card:
  - Name, truncated description
  - Type badge (Blueprint, Scenario, Image, etc.)
  - Tag chips
  - Status: Available / Installed / Update Available
  - Action button: "Install" / "Installed" (disabled) / "Update"

### Detail View

Clicking a card opens a detail panel/page:

- Full README content (rendered markdown)
- For blueprints: network topology summary, VM list, required images
- MSEL summary (if included)
- Content list (if included)
- Install button with progress indicator
- Dependencies shown (required images that need to be installed first)

### Admin: Catalog Sources Management

Under admin settings:

- List configured catalog sources with sync status
- Add new source (name, type, URL/path, branch)
- Edit / delete sources
- Manual "Sync Now" per source
- View sync history / errors

---

## Migration Plan

### Removed from CYROID repo

| Path | Content |
|------|---------|
| `data/seed-blueprints/` | Seed blueprint YAML files + manifest |
| `data/seed-templates/` | VM template manifest |
| `data/scenarios/` | Scenario YAML files |
| `data/images/` | Dockerfile projects |
| `backend/cyroid/services/blueprint_seeder.py` | Startup seeding logic |
| Seeding calls in `main.py` | `seed_all_blueprints()`, template seeding |

### Added to CYROID repo

| Path | Purpose |
|------|---------|
| `backend/cyroid/models/catalog.py` | CatalogSource + CatalogInstalledItem models |
| `backend/cyroid/api/catalog.py` | CRUD, sync, browse, install endpoints |
| `backend/cyroid/services/catalog_service.py` | Git clone/pull, index parsing, install orchestration |
| `frontend/src/pages/CatalogBrowser.tsx` | Catalog browser UI |
| `frontend/src/services/catalogApi.ts` | API client for catalog endpoints |
| Sidebar navigation entry | Link to /catalog |
| Admin settings section | Catalog source management |

### Unchanged

- Blueprint import/export system (reused by catalog install)
- Content Library, MSEL parser, all existing features
- Blueprint CRUD, deployment, instances

### First-Run Experience

- Fresh CYROID installs ship with no seed data
- Admin settings page prompts: "Add a catalog source to browse available training content"
- Documentation provides the official `cyroid-catalog` repo URL

### Backward Compatibility

- Existing installations keep their data (blueprints are in the DB, not filesystem)
- Seeder removal only affects new installs
- Release notes: "Seed data has moved to the cyroid-catalog repository. Configure it as a catalog source to access training content."

---

## API Endpoints

```
# Catalog Sources (admin)
GET    /api/catalog/sources              # List sources
POST   /api/catalog/sources              # Add source
PUT    /api/catalog/sources/{id}         # Update source
DELETE /api/catalog/sources/{id}         # Remove source
POST   /api/catalog/sources/{id}/sync    # Trigger sync

# Catalog Browsing
GET    /api/catalog/items                # List items (filterable by type, tags, search)
GET    /api/catalog/items/{id}           # Item detail (README, dependencies)
GET    /api/catalog/items/{id}/readme    # Raw README content

# Installation
POST   /api/catalog/items/{id}/install   # Install item
GET    /api/catalog/installed            # List installed items
DELETE /api/catalog/installed/{id}       # Uninstall (remove local resource)
GET    /api/catalog/updates              # Check for updates across all installed items
POST   /api/catalog/installed/{id}/update # Update installed item
```

---

## Implementation Phases

### Phase A: Catalog Repository

1. Create `cyroid-catalog` repo
2. Move existing seed data into the repo structure
3. Write `catalog.yaml` and item manifests
4. Build `scripts/generate-index.py`
5. Generate initial `index.json`

### Phase B: CYROID Backend Integration

1. Add `CatalogSource` and `CatalogInstalledItem` models + migration
2. Implement `catalog_service.py` (git sync, index parsing, install logic)
3. Add API endpoints for sources, browsing, and installation
4. Wire install actions into existing import pipelines

### Phase C: Frontend Catalog Browser

1. Build `CatalogBrowser.tsx` page with card grid
2. Add filters, search, tag chips
3. Build detail view with install flow
4. Add catalog source management to admin settings
5. Add sidebar navigation entry

### Phase D: CYROID Cleanup

1. Remove `data/seed-blueprints/`, `data/seed-templates/`, `data/scenarios/`, `data/images/`
2. Remove `blueprint_seeder.py` and startup seeding calls
3. Update docker-compose volume mounts
4. Update documentation and release notes
