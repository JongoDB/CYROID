# docker-compose.dev.yml
#
# Development configuration for CYROID
#
# This file provides local builds and hot-reload for development.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# Or copy to docker-compose.override.yml for automatic loading:
#   cp docker-compose.dev.yml docker-compose.override.yml
#   docker-compose up
#
services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: cyroid-api:latest
    environment:
      # Unset APP_VERSION so it reads from mounted VERSION file
      APP_VERSION: ""
      # Use GHCR DinD image (same as production)
      DIND_IMAGE: ${DIND_IMAGE:-ghcr.io/jongodb/cyroid-dind:latest}
    volumes:
      # Mount source code for hot-reload
      - ./backend:/app
      # Mount VERSION file for version display (separate path to avoid conflict)
      - ./VERSION:/etc/cyroid-version:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
      - ${CYROID_DATA_DIR:-/data/cyroid}/catalogs:${CYROID_DATA_DIR:-/data/cyroid}/catalogs
      # Runtime directories for catalog-installed content
      - ${CYROID_DATA_DIR:-/data/cyroid}/scenarios:/data/scenarios
      - ${CYROID_DATA_DIR:-/data/cyroid}/images:/data/images
      - ./traefik/dynamic:/app/traefik/dynamic
    # Enable hot-reload in development
    command: bash -c "alembic upgrade head && uvicorn cyroid.main:app --host 0.0.0.0 --port 8000 --reload"

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: cyroid-worker:latest
    environment:
      # Unset APP_VERSION so it reads from mounted VERSION file
      APP_VERSION: ""
      # Use GHCR DinD image (same as production)
      DIND_IMAGE: ${DIND_IMAGE:-ghcr.io/jongodb/cyroid-dind:latest}
      # Traefik dynamic config directory (shared with Traefik for DinD VNC routing)
      TRAEFIK_VNC_ROUTES_DIR: /app/traefik/dynamic
    volumes:
      # Mount source code for hot-reload
      - ./backend:/app
      # Mount VERSION file for version display (separate path to avoid conflict)
      - ./VERSION:/etc/cyroid-version:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CYROID_DATA_DIR:-/data/cyroid}/iso-cache:${CYROID_DATA_DIR:-/data/cyroid}/iso-cache
      - ${CYROID_DATA_DIR:-/data/cyroid}/template-storage:${CYROID_DATA_DIR:-/data/cyroid}/template-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/vm-storage:${CYROID_DATA_DIR:-/data/cyroid}/vm-storage
      - ${CYROID_DATA_DIR:-/data/cyroid}/shared:${CYROID_DATA_DIR:-/data/cyroid}/shared
      - ${CYROID_DATA_DIR:-/data/cyroid}/catalogs:${CYROID_DATA_DIR:-/data/cyroid}/catalogs
      # Runtime directories for catalog-installed content
      - ${CYROID_DATA_DIR:-/data/cyroid}/scenarios:/data/scenarios
      - ${CYROID_DATA_DIR:-/data/cyroid}/images:/data/images
      # Shared directory for Traefik dynamic config (VNC routes)
      - ./traefik/dynamic:/app/traefik/dynamic

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    image: cyroid-frontend:latest
    expose:
      - "5173"
    volumes:
      # Mount source code for hot-reload
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
    labels:
      # Override port for development (Vite dev server on 5173)
      - "traefik.http.services.frontend.loadbalancer.server.port=5173"
