# Docker Compose overrides for macOS development
#
# Usage: Run ./scripts/dev-setup.sh to automatically copy this file
#   Or manually: cp docker-compose.override.macos.yml docker-compose.override.yml
#
# This file:
#   1. Maps volume paths to local ./data/cyroid instead of /data/cyroid
#      (required on macOS since /data is not writable)
#   2. Sets DIND_HOST_* env vars so DinD containers mount from the correct
#      macOS host paths (not the container paths)

services:
  api:
    environment:
      # Tell DinD service where the data directories are on the Docker host
      # These are used when creating DinD containers (which mount from the host, not this container)
      DIND_HOST_ISO_CACHE: ${PWD}/data/cyroid/iso-cache
      DIND_HOST_VM_STORAGE: ${PWD}/data/cyroid/vm-storage
      DIND_HOST_TEMPLATE_STORAGE: ${PWD}/data/cyroid/template-storage
      DIND_HOST_SHARED: ${PWD}/data/cyroid/shared
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/cyroid/iso-cache:/data/cyroid/iso-cache
      - ./data/cyroid/template-storage:/data/cyroid/template-storage
      - ./data/cyroid/vm-storage:/data/cyroid/vm-storage
      - ./data/cyroid/shared:/data/cyroid/shared
      - ./data/cyroid/catalogs:/data/cyroid/catalogs
      # Runtime directories for catalog-installed content
      - ./data/cyroid/scenarios:/data/scenarios
      - ./data/cyroid/images:/data/images

  worker:
    environment:
      # Tell DinD service where the data directories are on the Docker host
      DIND_HOST_ISO_CACHE: ${PWD}/data/cyroid/iso-cache
      DIND_HOST_VM_STORAGE: ${PWD}/data/cyroid/vm-storage
      DIND_HOST_TEMPLATE_STORAGE: ${PWD}/data/cyroid/template-storage
      DIND_HOST_SHARED: ${PWD}/data/cyroid/shared
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/cyroid/iso-cache:/data/cyroid/iso-cache
      - ./data/cyroid/template-storage:/data/cyroid/template-storage
      - ./data/cyroid/vm-storage:/data/cyroid/vm-storage
      - ./data/cyroid/shared:/data/cyroid/shared
      - ./data/cyroid/catalogs:/data/cyroid/catalogs
      # Runtime directories for catalog-installed content
      - ./data/cyroid/scenarios:/data/scenarios
      - ./data/cyroid/images:/data/images

  registry:
    volumes:
      - ./data/cyroid/registry:/var/lib/registry
      - ./config/registry-config.yml:/etc/docker/registry/config.yml:ro
